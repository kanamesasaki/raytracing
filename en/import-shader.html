<!doctype html>
<html lang="jp">
  <head>
    <meta charset="UTF-8">
    <title>How to import GLSL shader scripts from JavaScript - Ray Tracing in WebGL</title>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <link rel="stylesheet" href="../style.css">
  </head>
  <header>
    <a href="index.html">Ray Tracing in WebGL</a> &#187;
    <a href="import-shader.html">How to import GLSL shader scripts from JavaScript</a>
    <span style="float: right"><ul class="select-lang">
        <li><a href="../en/index.html">English</a></li>
        <li><a href="../de/index.html">Deutsch</a></li>
        <li><a href="../ja/index.html">日本語</a></li>
    </ul></span>
  </header>

  <body>
    <h1>How to import GLSL shader scripts from JavaScript</h1>
    <p>
      WebGLをブラウザ上で使用する場合，HTMLのscriptタグ内にGLSLコードを直接書き込むことでシェーダのタスクを指定できる．
      ただ，この方法ではGLSLコードの管理やエディタ上での編集がやりにくいので，GLSLコード部分を別ファイルにして読み込めるようにしたい．
      おそらくすぐに思いつくのは以下のような書き方だが，残念ながらこれでは読み込むことはできない．
    </p>
    <pre><code>&lt;script src="shader.glsl" id="vertex-shader" type="x-shader/x-vertex">&lt;/script></code></pre>
    <p>
      そもそも，GLSLコードをHTMLファイルの中で読み込む必要があるかというとそんなことはない．
      最初に紹介したHTML内にべた書きする方法で行っているのは，GLSLコードを単なるテキストとしてJavaScriptから参照できるようにしているだけだ．
      なのでGLSLコードを別ファイルにする場合，そのコードをテキストとして直接JavaScriptから読み込んでしまえばよい．
      具体的にvertex shaderのコードであれば，以下のようにGLSLコード部分をbackticksで囲んでエクスポートするJavaScriptファイル(vertex-shader.glsl.js)を作る．
    </p>
<pre><code>export default `#version 300 es
precision mediump float;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;
uniform mat4 uNormalMatrix;
uniform vec3 uLightDirection;
uniform vec3 uLightDiffuse;
uniform vec3 uMaterialDiffuse;

in vec3 aVertexPosition;
in vec3 aVertexNormal;

out vec4 vVertexColor;

void main(void) {
    // Calculate the normal vector
    vec3 N = normalize(vec3(uNormalMatrix * vec4(aVertexNormal, 1.0)));

    // Normalized light direction
    vec3 L = normalize(uLightDirection);

    // Dot product of the normal product and negative light direction vector
    float lambertTerm = dot(N, -L);

    // Calculating the diffuse color based on the Lambertian reflection model
    vec3 Id = uMaterialDiffuse * uLightDiffuse * lambertTerm;

    // Set the varying to be used inside of the fragment shader
    vVertexColor = vec4(Id, 1.0);

    // Setting the vertex position
    gl_Position = uProjectionMatrix * uModelViewMatrix * vec4(aVertexPosition, 1.0);
}`
</code></pre>
    <p>これを，別のJavaScriptから以下のようにインポートして使用すればよい．このときvertexSourceにはGLSLコードがテキストとして入っている．</p>
<pre><code>import vertexSource from './vertex-shader.glsl.js'

shader = gl.createShader(gl.VERTEX_SHADER)
gl.shaderSource(shader, shaderString)
</code></pre>
    <p>
      この手法についての詳細は以下のページも参考にしてほしい．<br>
      <a href="https://stackoverflow.com/questions/14219947/why-do-shaders-have-to-be-in-html-file-for-webgl-program">https://stackoverflow.com/questions/14219947/why-do-shaders-have-to-be-in-html-file-for-webgl-program</a>
    </p>
    
  </body>
  <footer>
    <a href="index.html">Ray Tracing in WebGL</a> &#187;
    <a href="import-shader.html">How to import GLSL shader scripts from JavaScript</a>
    <span style="float: right">Copyright 2021, Kaname Sasaki</span>
  </footer>
</html>