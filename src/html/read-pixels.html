<!doctype html>
<html lang="en">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CCZTCJYRD8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-CCZTCJYRD8');
    </script>
    <meta charset="UTF-8">
    <title>Get data from a shader (GPGPU)</title>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <link rel="stylesheet" href="../style.css">
  </head>
  <header>
    <a href="index.html">Ray Tracing in WebGL2</a> &#187;
    <a href="import-shader.html">Get data from a shader (GPGPU)</a>
    <span style="float: right"><ul class="select-lang">
        <li><a href="../en/index.html">English</a></li>
        <li><a href="../de/index.html">Deutsch</a></li>
        <li><a href="../ja/index.html">日本語</a></li>
    </ul></span>
  </header>

  <body>
    <h1>Get data from a shader (GPGPU)</h1>
    <h2>Read pixels</h2>
    <p>
      Under the assumption of Lambertian reflection, the intensity of the reflected light obeys the Lambert's cosine law. 
      The intensity is described by \( I \cos \theta\) for a unit solid angle, where \(\theta\) is an angle with regard to the surface normal.
    </p>

    <h2>Uniform distribution on a sphere</h2>
    <p>
      単位球面上の位置を極座標\(~(\theta, \varphi)~\)で表すとき，各パラメタに対応する微小表面（微小立体角）は\(~\sin \theta d\varphi d\theta~\)で表される．
      この微小な表面積は\(~\theta~\)に応じて変化する（北極・南極付近で小さくなり，赤道付近で大きくなる）ため，
      球面上に一様に点をばらまくためには，表面積に比例するよう緯度方向について密度を調整する必要がある．
      一様にばらまかれた点から1つ選んで，それが\(0\le \theta \le \theta\)の範囲に含まれている確率\(p\)は次のように求められる．
    </p>
    $$
    \begin{equation}
    p = \frac{\int_0^{\theta} \int_0^{2\pi} \sin \theta d\varphi d\theta}{\int_0^{\pi} \int_0^{2\pi} \sin \theta d\varphi d\theta } 
    = \frac{[-\cos \theta]_{0}^{\theta}}{[-\cos \theta]_{0}^{2\pi}} = \frac{1-\cos \theta}{2} \tag{1}
    \end{equation}
    $$
    <p>
      この式を逆に解いてやると，0&ndash;1の値に対して球面上のパラメタ\(~\theta~\)を対応させることが出来る．
    </p>
    $$
    \begin{equation}
    \theta = \arccos (1-2p) \tag{2}
    \end{equation}
    $$
    <p>
      ただ球面上の一様分布は，逆三角関数を使わないもっと雑な方法でも作ることが出来る．
      具体的には，\(~[-1:1]^3~\)の立方体内にランダムに点を発生させて，点が単位球の外部であればやり直し，内部であれば正規化して値を返す，という手順を行えばよい．
    </p>

    <h2>Cosine distribution on a hemi-sphere</h2>
    <p>
      Lambertの余弦則に基づいた分布を得るには，微小表面に\(~\cos \theta~\)の重みをのせた\(~\sin \theta \cos \theta d\varphi d\theta~\)を確率密度関数と考えればよい．
      今回は半球上での分布を考えたいので，以下のように確率分布を求める．
    </p>
    $$
    \begin{equation}
    p = \frac{\int_0^{\theta} \int_0^{2\pi} \sin \theta \cos \theta d\varphi d\theta}{\int_0^{\pi/2} \int_0^{2\pi} \sin \theta \cos \theta d\varphi d\theta } 
    = \frac{[-\cos 2\theta]_{0}^{\theta}}{[-\cos 2\theta]_{0}^{\pi/2}} = \frac{1-\cos 2\theta}{2} \tag{3}
    \end{equation}
    $$
    <p>
      この式を逆に解いてやると，0~1の値に対して半球上のパラメタ\(~\theta~\)を対応させることが出来る．
    </p>
    $$
    \begin{equation}
    \theta = \frac{\arccos (1-2p)}{2} \tag{4}
    \end{equation}
    $$

    <h2>Implementation technique</h2>
    <p>
      Lambertの余弦則に基づいた分布を得たい場合，光の反射する点上に単位球面を描いて，球面上一様にばらまかれた点からランダムに1点選び反射方向を決める，という方法も可能である．
      実際，単位球面の緯度方向パラメタ\(~\theta'~\)と半球状の緯度方向パラメタ\(~\theta~\)の関係式(5)を用いて，式(2)を式(4)に変形出来る．
    </p>
    $$
    \begin{equation}
    \frac{\sin \theta'}{\cos \theta' + 1} = \tan \theta \tag{5}
    \end{equation}
    $$
    <p>
      式(2)より\(\cos \theta' = 1-2p\)なので，これを式(5)に代入して全体2乗すると次のように整理できる．
    </p>
    $$
    \begin{equation}
    \frac{p}{1-p} = \tan^2 \theta \tag{6}
    \end{equation}
    $$
    <p>
      \(\tan^2 \theta = \frac{1}{\cos^2 \theta} - 1\)と，倍角の公式\(~2\cos^2 \theta - 1 = \cos 2\theta~\)を用いて変形すると以下の式が得られる．
    </p>
    $$
    \begin{equation}
    \cos 2\theta = 1-2p \tag{7}
    \end{equation}
    $$
    <p>
      先ほど述べたように，球面上の一様分布は逆三角関数を使わなくても作れるので，
      Lambertの余弦則に従った分布も逆三角関数を使わずに作ることが出来る．
    </p>
    
    
  </body>
  <footer>
    <a href="index.html">Ray Tracing in WebGL2</a> &#187;
    <a href="import-shader.html">Reflection and shadowing</a>
    <span style="float: right">Copyright 2021, Kaname Sasaki</span>
  </footer>
</html>